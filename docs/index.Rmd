---
title: "Bloomington Animal Care and Control Data"
---
```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

Bloomington Animal Care and Control data is available through **[BClear](https://data.bloomington.in.gov/)**, a data portal for Bloomington, Indiana's city government. The Animal Care and Control Division has prepared two data sets that the public may use to understand how the city handles animal welfare. 

This notebook was created for the **BMG Hack's - Let's Get Visual - Civic Data Challenge**. The notebook provides a description of each data set, and provides code for the data processing performed on these data that (hopefully) will facilitate analysis and visualization that can be updated, re-used, and shared with others! 

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

## About the Original Data Sets

*  **[Annual Statistics (2004-2019)](https://data.bloomington.in.gov/dataset/animal-care-and-control/resource/7a847ec2-31c6-48e3-b0bc-02af2fa94587)** - These data represent high level annual statistics for the division, which includes revenue, budgets, staffing, counts of animal intakes and movements. These data is great for those interested in practicing implementing basic data visualizations using a tidy data set.

*  **[Adoptions (2017-Present)](https://data.bloomington.in.gov/dataset/adopted-animals/resource/8854ce02-e8f5-44b9-b85f-17f002a7d023)** - These data represent animal case records maintained by the division. This is a much larger and complex data set compared to the annual statistics. The Bloomington Animal Shelter, which uses the [Shelter Manager](https://www.sheltermanager.com/site/en_tour.html) database to manage its case load. The data provided by the city is a roll-up of multiple tables from the shelter database. Currently, there are over 12,000 intake records available to download.

# Data Documentation and Processing Notes

The data review and processing workflow for both data sets provided by Bloomington Animal Care and Control are documented  below. Processing result outputs are collected in a ZIP file and available for download in the link below. Data is provided in CSV format.

#### **[Processed Animal Care and Control  Data](https://github.com/mginda/bmghack-animalcontrol/raw/master/data/bmg-acc-data.zip)**

### Jump to:

* [Annual Statistics](https://mginda.github.io/bmghack-animalcontrol#annual-stats)
* [Animal Case Data](https://mginda.github.io/bmghack-animalcontrol#cases)

## Workflow Set-up

### R Environment

Here we set up the R environment, and load in the R Packages that will be used in the notebook.

```{r enviro, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
#Clean up environment
rm(list=ls())

#Packages used in notebook
library(curl)        # Data downloads via URL
library(tidyr)       # Tidyverse data processing piping, string manipulation
library(readr)       # Data parsing
library(plyr)        # Combining and Splitting Data
library(dplyr)       # Data analysis and aggregations
library(magrittr)    # Piping
```

### Loading Data from Animal Care and Control

Data is loaded directly into R using a CURL function that uses **BClear** URLS to data downloads for the Animal Care and Control data. Data is provided a CSVs with headers.

```{r data-load, echo=TRUE}
#Annual Statistics
annual <- read.csv(curl(url="https://data.bloomington.in.gov/dataset/9a0fc126-0775-4952-96ff-76ece67ffbc7/resource/7a847ec2-31c6-48e3-b0bc-02af2fa94587/download/animal-care-and-control-data-set-2004-2019.csv"), header=TRUE, stringsAsFactors = F)

#Intake and adoption records
intake <- read.csv(curl(url="https://data.bloomington.in.gov/dataset/94d3f457-57b5-45be-bee0-a0106f59b7ed/resource/8854ce02-e8f5-44b9-b85f-17f002a7d023/download/animals.csv"), header=TRUE, stringsAsFactors = F)
```

Before analyzing and visualizing these data, the variables in the data set were reviewed to ensure that they have the correct data type in R, and to determine how variables relate to each other. The data processing routine documented below is used to clean-up and reshape the data to aid development and resuse of these data in a visual analytics workflow.

## [Annual Statistics](#annual-stats)

### Data Structure

There are two issues with the Animial Care and Control Divisions' Annual Statistics data set:

1. Variables use verbose names with have had punctuation added for spaces and text is captialized;
2. Monetary values are captured as character strings with symbols and empty spaces rather than providing providing a numeric values. We need to fix these two issues with our data.

```{r str-an, echo=FALSE}
str(annual[,c(4,16,17)])
```

### Preparing Data

```{r pro-an, echo = T, results = 'hide'}
#Save original column name values
annual_cols <- colnames(annual)
#Substitutes periods from original column names with spaces
annual_cols <- gsub("\\.","\\ ",annual_cols)
#Renames fields to shorter values
names(annual) <- c("year","employees","vehicles","budget","surrender","stray","impound",
                   "intake","adopt","return","euthanize","tranfer","foster","serviceCalls",
                   "emergencyCalls","grants","revenue")

#Parse the budget, grants and revenue fields to create numeric values instead of character strings
annual$budget <- parse_number(annual$budget, na="NA")
annual$grants <- parse_number(annual$grants, na="NA")
annual$revenue <- parse_number(annual$revenue, na="NA")
```

Now we can get accurate descriptive data summaries for the `r length(colnames(annual))` variables in the Annual Statistics observations for the Animal Control Division. Variables measured, include:

* Number of employees - *employees* 
* Number of vehicles - *vehicles*
* Annual Budget - *budget* - $
* Grants Recieved - *grants* - $
* Revenue from Adoptions - *revenue* - $
* Service Calls - *serviceCalls*
* Emergency Calls - *emergencyCalls*
* Number of Owner Surrended - *surrender*
* Number of Strays - *stray*
* Number of Impounded - *impound*
* Total Number of Intakes - *intake*
* Number of Transfer to other Shelters - *transfer*
* Number of Fosters - *foster*
* Number of Adoptions - *adopt*
* Number of Returnes - *return*
* Number of Euthinizations - *euthenize*

### Summary Descriptive Statistics

```{r summary-an, echo=FALSE}
#Annual Statistics
summary(annual)
```

### Example Annual Statistics Observations

```{r head-an, echo=FALSE}
#Annual Statistics
head(annual)
```

## [Animal Case Data](#cases)

The Animal Case data set is more complex data set because it is a composite taken from from the Shelter Manager database. By reviewing the data structure and type and values of variable recorded across the observations (e.g. counts of values for catoregorical aka factor aka qualitative fields), cleaner data sets will be derived to aid analysis and visualization.

### Data Structure

There are `r length(rownames(intake))` observations across `r length(colnames(intake))` variables in this data set. The data structure provides a description of the variables, and is shown below. 

Reading variable names shows that the data set uses common subjects for related variables. Examples of variable relationships include fields starting with: *intake*, *movement*, *return*, and *deceased*. This suggests that there are a minimum of four tables combined in this data set. 

Data tables are likely combined by the *id* field, which acts as the primary key in the shelter database. This field will be used in all derived data subsets, to help join related data.

```{r str-in, echo=FALSE}
#Intake Structure
str(intake)
```

### Processing Intake Data for Visual Analytics

The goal of data processing is to create different subsets that best represent data for potential analysis and visualizations. The data sets derived from the origianl data set include:

1. [Animal Identification data](https://mginda.github.io/bmghack-animalcontrol#animals)
2. [Intake Case data](https://mginda.github.io/bmghack-animalcontrol#intakes)
3. [Movement data (adoptions, fosters, transfers, etc.)](https://mginda.github.io/bmghack-animalcontrol#moves)
4. [Returned Animals data](https://mginda.github.io/bmghack-animalcontrol#returns)
5. [Deceased Animals data](https://mginda.github.io/bmghack-animalcontrol#dead)
6. [Animal Case Intake and Outcome log](https://mginda.github.io/bmghack-animalcontrol#log)
7. [Supplemental Animal Statistics](https://mginda.github.io/bmghack-animalcontrol#sup)

#### Assigning Data Types
Before subsetting the animal case data set into cleaner subsets, it is processed to ensure that variables have the proper data types assigned. The data set requires transforming fields into factor/categorical variables, and dates. Note, *animalage* is ignored, but it is processed later in the *Animal Idenfification* data set.

```{r pro-in-datatypes, echo=TRUE, warning=TRUE}
#Copy intake to new data.frame data 
data <- intake

#List of factor variables column names
intake_fac <- colnames(data[,c(1,3,5:10,12,13,15,18,20)])
#Converts variables from character strings to factors
for(i in 1:length(intake_fac)){
  data[,intake_fac[i]] <- data[,intake_fac[i]] %>% as.factor()
}

#List of date variable column names
intake_date <- colnames(data[,c(2,14,17,19)])
#Convert variables from character strings to dates
for(i in 1:length(intake_date)){
  if(length(data[data[,intake_date[i]]=="",intake_date[i]])>0){
    data[data[,intake_date[i]]=="",intake_date[i]] <- NA
  }
  data[,intake_date[i]] <- data[,intake_date[i]] %>% as.Date()
}
rm(i, intake_date, intake_fac)
```

#### [1. Animal Identification Data](#animals)

This data set describes animals taken in by Animal Care and Control. Variables are described below with notes relevant for understanding the data set and potential processing requirements. The variables included in this data set are:

* Animal Case identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
  * This field acts as the primary key that will connect data sets together
* Shelter Code - *sheltercode* - a numeric unique identifier with `r length(unique(intake$sheltercode))`values.
  * The difference between unique identifers and total number of observations in the data set (`r length(rownames(intake))-length(unique(intake$sheltercode))`) indicates that there may be multiple intake records for a given animal in the data set.
  * The letter code starting each id indicates species class (e.g. `r intake[1,]$sheltercode` for cat).
* Animal identity chip - *identichipnumber* - factor variable with `r length(unique(intake$identichipnumber))` unique values
  * Not all animals have chip identifiers.
* Animal name - *animalname* - factor variable with `r length(unique(intake$animalname))` unique values
  * We've got some common names!
* Breed - *breedname* - factor variable with `r length(unique(intake$breedname))` unique values
* Animal coloration - *basecolour* - factor variable with `r length(unique(intake$basecolour))` unique values
* Species - *speciesname* - factor variable with `r length(unique(intake$speciesname))` unique values.
  * There are some surprises here
* Animal age (estimated) - *animalage* - string with values such as `r intake[1,]$animalage`
  * This field is valuable, but requires processing to extract a usable estimate of age (years or months)
* Animal sex - *sex* - factor variable with `r length(unique(intake$sexname))` unique values.

```{r pro-animals, echo=TRUE, warning=TRUE}
#Creates demographic data set of unique animals with intake cases
animals <- data[,c("id","sheltercode","identichipnumber","animalname","animalage","sexname","speciesname","breedname","basecolour")] %>% unique()

#Processes animal age to
tmp <- as.data.frame(as.character(animals$animalage),stringsAsFactors = F)
names(tmp) <- "animalage"
tmp$intakeage <- as.numeric(0)
for(i in 1:nrow(tmp)){
  #Converts string to a dataframe by way of 2 col matrice
  d <- stringr::str_split(tmp[i,]$animalage,"\\ ") %>% unlist() 
  if(length(d)==2){
    d <- d %>% matrix(ncol=2) %>% data.frame()
  } else {
    d <- d %>% matrix(ncol=2) %>% t() %>% data.frame()
  }
  d$X1 <- as.character(d$X1) %>% as.numeric()
  # Years to months
  if(length(d[d$X2=="years" | d$X2=="year",]$X2)>0){
    d[d$X2=="years" | d$X2=="year",]$X1 <- d[d$X2=="years" | d$X2=="year",]$X1 * 12
  }
  #Weeks to months
  if(length(d[d$X2=="weeks." | d$X2=="week.",]$X2)>0){
    d[d$X2=="weeks." | d$X2=="week.",]$X1 <- d[d$X2=="weeks." | d$X2=="week.",]$X1 * (1/4.5)
  }
  #Days to months
  if(length(d[d$X2=="days." | d$X2=="day.",]$X2)>0){
    d[d$X2=="weeks." | d$X2=="week.",]$X1 <- d[d$X2=="weeks." | d$X2=="week.",]$X1 * (1/30)
  }
  tmp[i,]$intakeage <- sum(d$X1)
}
#Creates new column in animals data.frame
animals$intakeage <- tmp$intakeage

#Removes objects
rm(i,d,tmp)

#Summarize intake cases
summary(animals)
```

#### [2. Intake Data](#intakes)

These fields describe intake data for animals managed by Animal Care and Control. The variables included in this data set are:

* Intake identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
  * The number of unqiue ids and unique shelter codes are identical. And, as with *sheltercodes* variable above, the count of unique *id* values is less than total intake records provided by the division. This suggests unique identifier is linked to the animal's intial intake.
* Intake date - *intakedate* - changed to -> *date* - a date field (YYYY-MM-DD) ranging from `r min(as.Date(intake$intakedate))` to `r max(as.Date(intake$intakedate))`.
  * Intake data sets may require more examination and potentiall filtering to removing intakes prior 2017, the first year when records begin were first collected in full.
  * Needs processing to as.Date() type.
* Intake reason - *intakereason*  - changed to -> *interaction* - a factor variable with `r length(unique(intake$intakereason))` unique values.
* Location within shelter - *location* - a factor variable with `r length(unique(intake$location))` unique values.
* Interation type - *type* - a new field that indicates the type of interaction with the shelter

```{r pro-intake, echo=TRUE, warning=TRUE}
#Creates demographic data set of unique animals with intake cases
intakes <- data[,c("id","intakedate","intakereason","location")] %>% unique()

#Update field names
names(intakes)[2:3] <- c("date","interaction")

#Interaction type
intakes$type <- "intake"

#Summarize intake cases
summary(intakes)
```

#### [3. Animals on the Move Data](#moves)

These fields describe adoptions of animals managed by Animal Care and Control. The variables included in this data set are:

* Animal Case identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
* Movement date - *movementdate* - changed to -> *date* - a date field (YYYY-MM-DD) ranging from `r min(as.Date(intake$movementdate))` to `r max(as.Date(intake$movementdate))`.
  * Needs processing to as.Date() data types.
* Movement type - *movementtype* - changed to -> *interaction* - a factor variable with `r length(unique(intake$movementtype))` unique values.
  * This field indicates what happens to an animal after the intake is logged. Values include: 
* Trial status - *istrial* - a binary (1/0) variable indicating if the animal is a trial adoption.
  * All values are currently *0*, meaning the field has no value and should be removed.
* Transfer status - *istransfer* - a binary (1/0) variable indicating if the animal is transferred from the system. 
* Interation type - *type* - a new field that indicates the type of interaction with the shelter system.

```{r pro-move, echo=TRUE, warning=TRUE}
#Creates demographic data set of unique animals with intake cases
move <- data[,c("id","movementdate","movementtype")] %>% 
  unique() %>% 
  arrange(id)
names(move)[2:3] <- c("date","interaction")
move$type <- "move"

#Summarize movements
summary(move)
```

#### [4. Returned Animals Data](#returns)

These fields describe data related to animal that return to Animal Care and Control. The variables included in this data set are:

* Animal Case identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
* Return date - *returndate* - changed to -> *date* - a date field (YYYY-MM-DD) ranging from `r min(as.Date(intake[intake$returndate!="",]$returndate))` to `r max(as.Date(intake[intake$returndate!="",]$returndate))`.
  * Not all intake records include a return date, indicating the animal has not been returned to the system.
  * Needs processing to as.Date() data types.
* Return reason - *returnedreason* - changed to -> *interaction* - a factor variable with `r length(unique(intake$returnedreason))` unique values.
  * Some interesting unique values include: `r head(unique(intake$returnedreason),3)`. 
  * This variable may be an interesting feature to explore reasons based on animal type and demographics. This may be useful for a predictive model at intake.
* Interation type - *type* - a new field that indicates the type of interaction with the shelter system.
  
```{r pro-return, echo=TRUE, warning=TRUE}
#Creates demographic data set of unique animals with intake cases
return <- data[,c("id","returndate","movementdate","returnedreason")] %>%
  unique() %>% 
  arrange(id)
return <- return[!is.na(return$returndate),]

#Update field names
names(return)[c(2,4)] <- c("date","interaction")

#Add interaction type
return$type <- "return"

#Time to return
return$duration <- difftime(return$date,return$date, unit="day")

#Summarize intake cases
summary(return)
```

#### [5. Deceased Animals Data](#dead)

These fields describe data related to animal that have died while managed by Animal Care and Control. The variables included in this data set are: 

* Animal Case identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
* Deceased date - *deceaseddate* - changed to -> *date* - a date field (YYYY-MM-DD) ranging from `r min(as.Date(intake[intake$deceaseddate!="",]$deceaseddate))` to `r max(as.Date(intake[intake$deceaseddate!="",]$deceaseddate))`.
  * Not all intake records include a deceased date, indicating the animal is alive!
  * Needs processing to as.Date() data types.
* Deceased reason - *deceasedreason* - changed to -> *interaction* - a factor variable with `r length(unique(intake$deceasedreason))` unique values.
  * Some interesting unique values include: `r head(unique(intake$deceasedreason),3)`. 
  * This variable may be an interesting feature to explore reasons based on animal type and demographics. This may be useful for a predictive model at intake.
  * All animals have a deceased reason even if they are not dead.
* Animal died off selter - *diedoffshelter* -  a binary (1/0) variable indicating if the animal is died outside of the shelter.
* Euthanize flag - *puttosleep* - a binary (1/0) variable indicating if the animal is euthanized from the system.
* Dead on arrival flag - *isdoa* - a binary (1/0) variable indicating if the animal is died when they arrived at the shelter.
* Interation type - *type* - a new field that indicates the type of interaction with the shelter system.

```{r pro-doa, echo=TRUE, warning=TRUE}
#Creates demographic data set of unique animals with intake cases
dead <- data[,c("id","deceaseddate","deceasedreason",
                "diedoffshelter","puttosleep","isdoa")] %>% unique()
dead <- dead[!is.na(dead$deceaseddate),]

#Update field names
names(dead)[2:3] <- c("date","interaction")

#Adds interaction type
dead$type <- "dead"

#Summarize intake cases
summary(dead)
```

#### [6. Animal Case Interaction Log](#log)


* Animal Case identifier - *id* - a numeric unique identifier with `r length(unique(intake$id))` unique values.
* Interaction date - *date* - a date field (YYYY-MM-DD) for an interaction with the shelter system.
* Interaction - *interaction* - a factor variable that describes the interaction with the shelter system.
* Interation type - *type* - a factor variable that indicates the type of interaction with the shelter system (e.g intake, movement, return, dead).
* Duration - *duration* - Measure of time between an interaction with the shelter system, measured in days.

```{r pro-ani-log}
#Creating shelter interaction dataframe
interactions <- rbind(intakes[,c("id","date","interaction","type")],
                    move[,c("id","date","interaction","type")],
                    return[,c("id","date","interaction","type")],
                    dead[,c("id","date","interaction","type")]) %>% 
                arrange(id,date)

#Loop calculates duration between shelter interaction for each animal's case
interactions$duration <- NA
for(i in 1:length(unique(intakes$id))){
  tmp <- interactions[interactions$id==intakes[i,]$id,c("id","date","duration")]
  dur <- difftime(tmp[2:nrow(tmp),]$date,tmp[1:(nrow(tmp)-1),]$date,unit="day") %>% 
           unclass() %>% 
           as.numeric()
  dur <- c(dur,NA)
  tmp$duration <- dur
  interactions[interactions$id==intakes[i,]$id,]$duration <- tmp$duration
}

#Transforms type into a factor variables
interactions$type <- as.factor(interactions$type)

#Clean environment
rm(tmp,dur,i)

#Summary of data
summary(interactions)
```

#### [7. Supplemental Statistic for Animal Data](#sup)

* Total time in shelter - 
* Number of Interactions with Shelter - 
* Adopted - t/f or count
* Fostered - t/f or count
* Reclaimed - t/f or count
* Returned - count

```{r pro-ani-sup}
#New data frame of supplemental stats
animals_s <- animals

#Total Shelter Interactions (Intake+Returns+Movements+Deaths)


#Time in Selter


#Adopted



#Fostered



#Returned Count
animals_s$hasReturned <- 0
tmp <- ddply(return,~id,summarise,
             hasReturned = length(date)
             )
animals_s <- join(animals_s,tmp,by="id")

#Death stats


  
  
summary(animals_s)
```
